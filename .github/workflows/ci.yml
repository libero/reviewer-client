name: CI

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - master
env:
  IMAGE_TAG: ${{ github.sha }}

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - uses: bahmutov/npm-install@v1
      - name: Lint
        run: yarn lint
      - name: Unit Test
        run: yarn test

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - uses: bahmutov/npm-install@v1
      - name: Setup
        run: make setup
      - name: Build
        run: make build
      - name: Save Docker images
        run: |
          mkdir -p docker-image
          docker save -o docker-image/reviewer-client.tar libero/reviewer-client:${IMAGE_TAG}
          gzip docker-image/reviewer-client.tar
      - name: Upload prod Docker image
        uses: actions/upload-artifact@v1
        with:
          name: docker-image
          path: docker-image
      
  browser-test:
    needs: [test, build]
    runs-on: ubuntu-latest
    steps:
        - uses: actions/checkout@v1
        - uses: bahmutov/npm-install@v1
        - name: Load Docker image
          run: |
            gunzip docker-image/reviewer-client.tar.gz
            docker load -i docker-image/reviewer-client.tar
        - name: Browser Test
          run: make test_browser


  
